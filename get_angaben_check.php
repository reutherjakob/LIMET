<?php
// 25 FX
$allElementMappings = [
    12 => ['param' => '1 Kreis DL-5'], // Deckenstativ ICU - Tandem - 2 armig,1.61.12.1
    66 => ['param' => '1 Kreis DL-5'], // DL-5 in DVE,5.50.11.3
    69 => ['param' => '1 Kreis DL-5'], // DL-5 Wandentnahmestelle,5.50.10.3
    77 => ['param' => '1 Kreis DL-5'], // DL-5 in MVE,5.50.11.6
    154 => ['param' => '1 Kreis DL-5'], // Deckenstativ Endoskopie - 2 armig - Endoskopieturm,1.61.12.2
    155 => ['param' => '1 Kreis DL-5'], // Deckenstativ Endoskopie - 2 armig - für Monitore,1.61.12.3
    165 => ['param' => '1 Kreis DL-5'], // Deckenstativ Schockraum - Tandem - 2 armig,1.61.12.4
    194 => ['param' => '1 Kreis DL-5'], // Deckenstativ Anästhesie - 1 armig,1.61.12.5
    233 => ['param' => '1 Kreis DL-5'], // Deckenstativ Universal - 1 armig,1.61.12.6
    286 => ['param' => '1 Kreis DL-5'], // Deckenstativ OP Chir - 2 armig,1.61.12.7
    287 => ['param' => '1 Kreis DL-5'], // Deckenstativ Anästhesie - 2 armig,1.61.12.8
    393 => ['param' => '1 Kreis DL-5'], // Deckenstativ Endoskopie - Tandem - 2 armig,1.61.12.9
    485 => ['param' => '1 Kreis DL-5'], // Deckenstativ OP - Liftarm,1.61.12.10
    680 => ['param' => '1 Kreis DL-5'], // Deckenstativ Monitortragarm - 2 armig,1.61.12.11
    907 => ['param' => '1 Kreis DL-5'], // Deckenstativ OP - Tandem - 2 armig - Chir/Monitor,1.61.12.12
    1001 => ['param' => '1 Kreis DL-5'], // Deckenstativ Liftarm - 1 armig,1.61.12.13
    1074 => ['param' => '1 Kreis DL-5'], // Deckenstativ 2 armig - Medien,1.61.12.14
    1076 => ['param' => '1 Kreis DL-5'], // Deckenstativ für Waagenbedieneinheit,9.30.35.10
    1088 => ['param' => '1 Kreis DL-5'], // DL in Digestorium,5.50.12.3
    1105 => ['param' => '1 Kreis DL-5'], // DL in Labormedienzelle,5.50.12.7
    1553 => ['param' => '1 Kreis DL-5'], // Deckenstativ Monitortragarm - Tandem - 2 armig,1.61.12.15
    1654 => ['param' => '1 Kreis DL-5'], // Deckenstativ Schockraum 2-armig,1.61.12.16

    64 => ['param' => '1 Kreis O2'], // O2 in DVE,5.50.11.1
    67 => ['param' => '1 Kreis O2'], // O2 Wandentnahmestelle,5.50.10.1
    75 => ['param' => '1 Kreis O2'], // O2 in MVE,5.50.11.4
    1086 => ['param' => '1 Kreis O2'], // O2 in Digestorium,5.50.12.1
    1103 => ['param' => '1 Kreis O2'], // O2 in Labormedienzelle,5.50.12.5


    65 => ['param' => '1 Kreis Va'], // VA in DVE,5.50.11.2
    68 => ['param' => '1 Kreis Va'], // VA Wandentnahmestelle,5.50.10.2
    76 => ['param' => '1 Kreis Va'], // VA in MVE,5.50.11.5
    1087 => ['param' => '1 Kreis Va'], // VA in Digestorium,5.50.12.2
    1104 => ['param' => '1 Kreis Va'], // VA in Labormedienzelle,5.50.12.6

    342 => ['param' => 'CO2'], // CO2 Wandentnahmestelle,5.50.10.7
    289 => ['param' => 'CO2'], // CO2 in DVE,5.50.11.10
    1089 => ['param' => 'CO2'], // CO2 in Digestorium,5.50.12.4
    1090 => ['param' => 'CO2'], // CO2 in MVE,5.50.11.11
    1106 => ['param' => 'CO2'], // CO2 in Labormedienzelle,5.50.12.8

    163 => ['param' => 'DL-10'], // DL-10 Wandentnahmestelle,5.50.10.6
    288 => ['param' => 'DL-10'], // DL-10 in DVE,5.50.11.9

    1327 => ['param' => 'N2'], // N2 in Labormedienzelle,5.50.12.9

    161 => ['param' => 'N2O'], // N2O Wandentnahmestelle,5.50.10.4
    203 => ['param' => 'N2O'], // N2O in DVE,5.50.11.8
    162 => ['param' => 'NGA'], // NGA Wandentnahmestelle,5.50.10.5
    202 => ['param' => 'NGA'], // NGA in DVE,5.50.11.7

    727 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug,9.30.45.3
    1212 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium - begehbar,9.30.45.20
    1456 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium / Tischabzug EX,9.30.45.23
    1600 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 1200,9.30.45.25
    1601 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 1500,9.30.45.26
    1602 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 1800,9.30.45.27
    1603 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 2100,9.30.45.28
    1604 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 1500 - Spez Abrauch,9.30.45.29
    1605 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 1500 - Spez HF,9.30.45.30
    1606 => ['param' => "HT_Abluft_Digestorium_Stk"], // Digestorium/Tischabzug 1500 - Radionuklid,9.30.45.31

    1092 => ['param' => ["HT_Abluft_Sicherheitsschrank_Stk", "HT_Abluft_Sicherheitsschrank_Unterbau_Stk"]], // Gefahrenstoffsicherheitsschrank - Säuren/Laugen,4.35.30.2
    1093 => ['param' => ["HT_Abluft_Sicherheitsschrank_Stk", "HT_Abluft_Sicherheitsschrank_Unterbau_Stk"]], // Gefahrenstoffsicherheitsschrank - brennbare Flüssigkeiten,4.35.30.3
    1112 => ['param' => ["HT_Abluft_Sicherheitsschrank_Stk", "HT_Abluft_Sicherheitsschrank_Unterbau_Stk"]], // Gefahrenstoffsicherheitsschrank - Gasflaschen,4.35.30.4
    1688 => ['param' => ["HT_Abluft_Sicherheitsschrank_Stk", "HT_Abluft_Sicherheitsschrank_Unterbau_Stk"]], // Gefahr-Stoffsicherheitsschrank Unterbau - brennb Flüssigkeit,4.35.30.5


    570 => ['param' => 'Laseranwendung'], // Chirurgielaser,2.34.19.1
    778 => ['param' => 'Laseranwendung'], // CO2 - Laser,2.34.19.2
    890 => ['param' => 'Laseranwendung'], // Rauchgasabsaugung Laser,2.34.19.3
    989 => ['param' => 'Laseranwendung'], // Laser-Therapiegerät,2.56.16.1
    1331 => ['param' => 'Laseranwendung'], // Laser - Augen - Argon,2.34.19.4
    1332 => ['param' => 'Laseranwendung'], // Laser - Augen - Nd:YAG,2.34.19.5
    1909 => ['param' => 'Laseranwendung'], // Laser - Fläche - Dermatologie,2.56.16.3

    60 => ['param' => ['EL_Roentgen 16A CEE Stk', 'Strahlenanwendung']], // Röntgenaufnahmegerät digital - fahrbar,2.41.13.1
    167 => ['param' => ['EL_Roentgen 16A CEE Stk', 'Strahlenanwendung']], // C-Bogen - fahrbar,2.42.10.1
    168 => ['param' => 'Strahlenanwendung'], // Röntgenaufnahmesystem - Deckenstativ,1.41.12.1
    170 => ['param' => 'Strahlenanwendung'], // Röntgenaufnahmesystem - 3D Deckenstativ,1.41.12.2
    259 => ['param' => 'Strahlenanwendung'], // Röntgendiagnostik - System - Durchleuchtung,1.42.10.1
    317 => ['param' => 'Strahlenanwendung'], // SPECT,1.47.10.1
    484 => ['param' => 'Strahlenanwendung'], // Kontrastmittelinjektor CT - deckenmontiert,1.49.10.1
    489 => ['param' => 'Strahlenanwendung'], // SPECT/CT,1.47.15.1
    579 => ['param' => 'Strahlenanwendung'], // Angiographieanlage - Kardiologisch - 2Ebenen,1.42.13.1
    580 => ['param' => 'Strahlenanwendung'], // Angiographieanlage - Radiologisch - Intervention,1.42.12.1
    1182 => ['param' => 'Strahlenanwendung'], // Panoramaröntgensystem - Boden/Decke,1.41.12.3
    1388 => ['param' => 'Strahlenanwendung'], // Angiographieanlage - Kardiologisch - 1 Ebene,1.42.13.2
    1390 => ['param' => 'Strahlenanwendung'], // Röntgendetektorhalterung - fahrbar,2.41.13.4
    1417 => ['param' => 'Strahlenanwendung'], // Mammographie - System,1.46.10.1
    1461 => ['param' => 'Strahlenanwendung'], // Röntgenraster Wandhalterung,1.41.10.2
    1462 => ['param' => 'Strahlenanwendung'], // Linearbeschleuniger-System,1.71.10.1
    1660 => ['param' => 'Strahlenanwendung'], // Unterkonstruktion Angiographieanlage - Kardiologisch,1.42.13.3
    1680 => ['param' => 'Strahlenanwendung'], // Uroskopie - System - Durchleuchtung,1.42.10.5

    118 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Kardiologisch,2.45.19.1
    119 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Urologisch,2.45.29.1
    120 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - ICU,2.45.26.1
    122 => ["param" => "Abdunkelbarkeit"], // Ultraschallgerät - transkranieller Doppler,2.45.15.1
    153 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - ZNA,2.45.17.1
    253 => ["param" => "Abdunkelbarkeit"], // Ultraschalltherapiegerät,2.56.14.1
    256 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Gynäkologisch,2.45.21.1
    268 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Neurologie,2.45.25.1
    312 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Radiologisch,2.45.18.1
    431 => ["param" => "Abdunkelbarkeit"], // Fluoreszenzmikroskop,9.30.40.2
    573 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Anästhesie,2.45.27.1
    594 => ["param" => "Abdunkelbarkeit"], // Ultraschall - Gewebeablationsgerät,2.34.13.4
    615 => ["param" => "Abdunkelbarkeit"], // Ultraschallgerät - Bronchial,2.45.15.3
    620 => ["param" => "Abdunkelbarkeit"], // Endoskopie - Kaltlichtquelle,2.36.13.3
    624 => ["param" => "Abdunkelbarkeit"], // Endoskopiewagen,2.21.14.8
    637 => ["param" => "Abdunkelbarkeit"], // Ultraschall Video-Gastroskop,2.36.11.11
    638 => ["param" => "Abdunkelbarkeit"], // Ultraschall Video-Bronchoskop,2.36.11.12
    658 => ["param" => "Abdunkelbarkeit"], // HF - Ultraschall - Kombinationsgerät,2.34.13.5
    693 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Thorax,2.45.28.1
    770 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - HNO,2.45.23.1
    874 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Physiotherapie,2.45.18.2
    1042 => ["param" => "Abdunkelbarkeit"], // Ultraschallbad Tischgerät,2.82.12.1
    1083 => ["param" => "Abdunkelbarkeit"], // Ultraschallgerät - Endoskopie - Doppler,2.45.15.4
    1362 => ["param" => "Abdunkelbarkeit"], // Endoskopie - Kaltlichtquelle LED - mobil,2.36.13.9
    1368 => ["param" => "Abdunkelbarkeit"], // Atemtherapie - Ultraschallverneblung,2.32.17.5
    1498 => ["param" => "Abdunkelbarkeit"], // Intravaskuläres Ultraschallsystem (IVUS),2.45.20.1
    1503 => ["param" => "Abdunkelbarkeit"], // Endobronchiales Ultraschallsystem,2.36.17.1
    1525 => ["param" => "Abdunkelbarkeit"], // Ultraschallsystem - Gefäße,2.45.19.2
    1686 => ["param" => "Abdunkelbarkeit"], // Endoskopie - Spülpumpe Arthroskopie,2.36.13.11
    1892 => ["param" => "Abdunkelbarkeit"], // Ultraschallgerät - intra operat - Kardiologie,2.45.15.6
];


$IDsWandverstärkung = [1554, 1905, 10, 1730, 370, 372, 1039, 1933, 70,
    529, 74, 523, 1044, 524, 525, 526, 527,
    528, 1045, 548, 721, 722, 549, 723, 1008,
    873, 383, 856, 817, 1049, 983, 870, 1713,
    717, 238, 186, 550, 169, 1911, 282, 1837,
    1460, 1243, 381, 906, 382, 684, 281];
// tabelle_parameter id: 97    ist der Elementparameter Wandverstärkung

// ------------------- ERROR MESSAGES -------------------

const ERROR_MESSAGES = [
    'dependency_non_zero' => '%s: %s --- %s:::Raumparameter - %s -> %s ist %s, aber %s ist %s<br>',
    'max_value' => '%s: %s --- %s:::Raumparameter - LeistungZ SV-> %s...%s übersteigt max=%s.<br>',
    'max_value_rev' => '%s: %s --- %s:::Raumparameter - Abwärme%s-> %s übersteigt Raumangabe=%s.<br>',
    'rg_sv' => '%s: %s --- %s:::RG -> SV=%s, aber RG =%s.<br>',
    'rg_zsv' => '%s: %s --- %s:::RG = 2 -> ZSV=%s, aber RG =%s.<br>',
    'rg_floor' => '%s: %s --- %s:::RG = 2 -> Fußboden muss Klasse 1 sein, ist aber %s.<br>',
    'rg_floor2' => '%s: %s --- %s:::RG is nicht 2 -> Muss der Fussboden OENORM B5220 hier Klasse 1 sein? %s.<br>',
    'sum_leistung' => '%s: %s --- %s:::Raumparameter - Leistung ∑-> %s= ∑Anschlussleistung(Raum) != ∑P je Netzart! (%s=%s)<br>',
    'element_param' => '%s: %s --- %s:::Raumparameter - ElementPort-> %s Element %s präsent, aber Raumparameter=%s %s! <br>',
    'na_missing' => '%s: %s --- %s:::Raumparameter - Netzarten-> %s in  Element präsent, aber Raumparameter=0!<br>',
    'element_param4' => '%s: %s --- %s:::Raumparameter - Elemente -> Element %s präsent, aber Raumparam %s= %s! <br>',
    'element_param4z' => '%s: %s --- %s:::Raumparameter - Elemente -> Element %s präsent, aber Elementparameter %s= %s! <br>',
    'stativ_dl5' => '%s: %s --- %s:::Elementparameter - Stativ ->  Stativ, braucht Druckluft! <br>',
    'stativ_vorabsperr' => '%s: %s --- %s:::ElementPort -> Gasanschluss am Stativ, braucht Vorabsperrkasten! <br>',
    'leistung_na_missing' => '%s: %s --- %s:::Netzarten->  %s hat Leistung aber keine Netzart!<br>',
    'leistung_zero_na' => '%s: %s --- %s:::Leistung Elemente in Raum%s -> P[Elemente][%s]=0, aber Raumparameter=1? Element parametrisieren oder NA aus Raum hinterfragen <br>',
    'leistung_sum' => '%s: %s --- %s:::Raumparameter - Leistung ∑%s-> ∑P[%s](Elemente) =%s > %s_W=%s <br>',
    'leistung_8kW' => '%s: %s --- %s:::Raumparameter - Leistung ∑%s-> P[%s](Elemente) > 8kW! <br>',
    'no_errors' => '%s: %s --- %s:::INFO  ->  Keine Fehler gefunden.<br>',

];

// ------------------- UTILITY FUNCTIONS -------------------
function abcTo123($char): int
{
    return ord(strtolower($char)) - ord('a') + 1;
}

function unitMultiplier($text): float|int
{
    if (stripos($text, 'k') !== false) return 1000;
    if (stripos($text, 'M') !== false) return 1000000;
    if (stripos($text, 'm') !== false) return 0.001;
    return 1;
}


function getComponents($input): array
{
    $valid = ["AV", "SV", "ZSV", "USV"];
    return array_values(array_filter(explode("/", $input), fn($c) => in_array($c, $valid)));
}

function getUniqueComponents($new, $existing)
{
    foreach ($new as $c) if (!in_array($c, $existing)) $existing[] = $c;
    return $existing;
}

function e($v): string {
    return htmlspecialchars((string)($v ?? ''), ENT_QUOTES, 'UTF-8');
}

// ------------------- ROOM PARAMETER CHECKS -------------------
function check_dependency_non_zero(&$msgs, $roomParams, $p1, $p2)
{
    if (($roomParams[$p2] ?? 0) > 0 && (($roomParams[$p1] ?? 0) < 1)) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['dependency_non_zero'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume'],
            e($p2),
            e($p1),
            e($roomParams[$p1] ?? 'n/a'),
            e($p2),
            e($roomParams[$p2])
        );
    }
}

function check_max_value(&$msgs, $roomParams, $param, $max)
{
    if (($roomParams[$param] ?? 0) > $max) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['max_value'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume'],
            e($param),
            e($roomParams[$param]),
            (int)$max
        );
    }
}

function check_max_value_rev(&$msgs, $roomParams, $param, $max, $extra = "")
{
    if (!isset($roomParams[$param]) || $roomParams[$param] < $max) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['max_value_rev'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume'],
            e($extra),
            (int)$max,
            e($roomParams[$param] ?? 'n/a')
        );
    }
}

function check_RG(&$msgs, $roomParams)
{
    $rg = $roomParams['Anwendungsgruppe'] ?? null;
    $sv = $roomParams['SV'] ?? null;
    $zsv = $roomParams['ZSV'] ?? null;
    $fb = $roomParams['Fussboden OENORM B5220'] ?? null;

    if ($rg !== null) {
        if ($rg >= 1 && $sv != 1) {
            $msgs[] = sprintf(
                ERROR_MESSAGES['rg_sv'],
                e($roomParams['Raumbezeichnung']),
                e($roomParams['Raumnr']),
                (int)$roomParams['idTABELLE_Räume'],
                e($sv),
                (int)$rg
            );
        }
        if ($rg == 2 && $zsv != 1) {
            $msgs[] = sprintf(
                ERROR_MESSAGES['rg_zsv'],
                e($roomParams['Raumbezeichnung']),
                e($roomParams['Raumnr']),
                (int)$roomParams['idTABELLE_Räume'],
                e($zsv),
                (int)$rg
            );
        }
        if ($rg == 2 && $fb != "Klasse 1") {
            $msgs[] = sprintf(
                ERROR_MESSAGES['rg_floor'],
                e($roomParams['Raumbezeichnung']),
                e($roomParams['Raumnr']),
                (int)$roomParams['idTABELLE_Räume'],
                e($fb)
            );
        }
        if ($rg != 2 && $fb === "Klasse 1") {
            $msgs[] = sprintf(
                ERROR_MESSAGES['rg_floor2'],
                e($roomParams['Raumbezeichnung']),
                e($roomParams['Raumnr']),
                (int)$roomParams['idTABELLE_Räume'],
                e($fb)
            );
        }
    }
}

function check_summe_leistungen(&$msgs, $roomParams): void
{
    $av  = (int)($roomParams['ET_Anschlussleistung_AV_W'] ?? 0);
    $sv  = (int)($roomParams['ET_Anschlussleistung_SV_W'] ?? 0);
    $zsv = (int)($roomParams['ET_Anschlussleistung_ZSV_W'] ?? 0);
    $usv = (int)($roomParams['ET_Anschlussleistung_USV_W'] ?? 0);

    $sum    = $av + $sv + $zsv + $usv;
    $gesamt = (int)($roomParams['ET_Anschlussleistung_W'] ?? 0);

    if ($sum != $gesamt) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['sum_leistung'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume'],
            e($roomParams['ET_Anschlussleistung_W'] ?? 'n/a'),
            $sum,
            e(implode("+", [$av, $sv, $zsv, $usv]))
        );
    }
}

// ------------------- ELEMENT CHECKS -------------------
function check_room_for_parameters_cause_elementParamKathegorie(&$msgs, $roomParams, $paramID, $row): void
{
    $map = [
        117 => '1 Kreis O2', 121 => '1 Kreis DL-5', 122 => '1 Kreis Va', 123 => 'DL-10',
        124 => 'NGA', 125 => 'N2O', 126 => 'CO2', 127 => 'ET_RJ45-Ports'
    ];
    $name = $map[$paramID] ?? null;

    if ($name && (($roomParams[$name] ?? 0) < 1)) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['element_param'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume'],
            e($name),
            e($row['Bezeichnung']),
            e($name),
            e($roomParams[$name] ?? 'n/a')
        );
    }
}

function check_room_for_na(&$msgs, $roomParams, $NAs): void
{
    foreach ($NAs as $na) {
        if (($roomParams[$na] ?? 0) < 1) {
            $msgs[] = sprintf(
                ERROR_MESSAGES['na_missing'],
                e($roomParams['Raumbezeichnung']),
                e($roomParams['Raumnr']),
                (int)$roomParams['idTABELLE_Räume'],
                e($na)
            );
        }
    }
}

function check_4_room_param(&$msgs, $roomParams, $param, $row): void
{
    if (($roomParams[$param] ?? 0) < 1) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['element_param4'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume'],
            e($row['Bezeichnung']),
            e($param),
            e($roomParams[$param] ?? 'n/a')
        );
    }
}

function check4vorabsperr(&$msgs, $roomParams, $elements_in_room): void
{
    if ((int)($roomParams["1 Kreis DL-5"] ?? 0) === 0) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['stativ_dl5'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume']
        );
    }

    $found = false;
    foreach ($elements_in_room as $el) {
        if ($el["idTABELLE_Elemente"] == 664) {
            $found = true;
            break;
        }
    }

    if (!$found) {
        $msgs[] = sprintf(
            ERROR_MESSAGES['stativ_vorabsperr'],
            e($roomParams['Raumbezeichnung']),
            e($roomParams['Raumnr']),
            (int)$roomParams['idTABELLE_Räume']
        );
    }
}

function check_room_Leistungssumme(&$msgs, $roomParams, $P, $extra = ""): void
{
    $map = ["NoNA", "AV", "SV", "ZSV", "USV"];

    foreach ($P as $i => $val) {
        if ($i > 0 && $i < 5) {
            $limit = (int)($roomParams['ET_Anschlussleistung_' . $map[$i] . '_W'] ?? 0);

            if ($val > $limit) {
                $msgs[] = sprintf(
                    ERROR_MESSAGES['leistung_sum'],
                    e($roomParams['Raumbezeichnung']),
                    e($roomParams['Raumnr']),
                    (int)$roomParams['idTABELLE_Räume'],
                    e($extra),
                    e($map[$i]),
                    $val,
                    e($map[$i]),
                    $limit
                );
            }

            if ($val > 8000 && $i === 3) {
                $msgs[] = sprintf(
                    ERROR_MESSAGES['leistung_8kW'],
                    e($roomParams['Raumbezeichnung']),
                    e($roomParams['Raumnr']),
                    (int)$roomParams['idTABELLE_Räume'],
                    e($extra),
                    e($map[$i])
                );
            }
        }

        if ($val === 0 && $i > 0 && ($roomParams[$map[$i]] ?? 0) === 1) {
            $msgs[] = sprintf(
                ERROR_MESSAGES['leistung_zero_na'],
                e($roomParams['Raumbezeichnung']),
                e($roomParams['Raumnr']),
                (int)$roomParams['idTABELLE_Räume'],
                e($extra),
                e($map[$i])
            );
        }
    }
}

function distribute($x, $P, $NAs)
{
    $map = ["AV" => 1, "SV" => 2, "ZSV" => 3, "USV" => 4];
    if ($x > 0) {
        if (empty($NAs)) {
            $P[0] += $x;
        } else {
            foreach ($NAs as $NA) {
                if (isset($map[$NA])) {
                    $P[$map[$NA]] += $x / count($NAs);
                } else {
                    $P[0] += $x;
                }
            }
        }
    }
    return $P;
}



// ------------------- MAIN -------------------
if (!function_exists('utils_connect_sql')) include "utils/_utils.php";
check_login();

$messages = [];
$roomIDsArray = [];

if (($roomID = getPostInt('roomID')) !== null) {
    $roomIDsArray = explode(',', $roomID);
}

$mysqli = utils_connect_sql();

$stmt = $mysqli->prepare(
    "SELECT * FROM tabelle_räume
     INNER JOIN tabelle_funktionsteilstellen ON tabelle_räume.TABELLE_Funktionsteilstellen_idTABELLE_Funktionsteilstellen = tabelle_funktionsteilstellen.idTABELLE_Funktionsteilstellen
     WHERE tabelle_räume.tabelle_projekte_idTABELLE_Projekte = ? 
     ORDER BY tabelle_räume.tabelle_projekte_idTABELLE_Projekte"
);
$stmt->bind_param("i", $_SESSION["projectID"]);
$stmt->execute();
$result = $stmt->get_result();
$raumparameter = [];

while ($row = $result->fetch_assoc()) {
    $raumparameter[$row['idTABELLE_Räume']] = $row;
}

$stmt = $mysqli->prepare(
    "SELECT tabelle_projekt_elementparameter.Wert, tabelle_projekt_elementparameter.Einheit, tabelle_projekt_elementparameter.tabelle_Varianten_idtabelle_Varianten, 
            tabelle_projekt_elementparameter.tabelle_elemente_idTABELLE_Elemente, tabelle_parameter.Bezeichnung, tabelle_parameter_kategorie.Kategorie, 
            tabelle_parameter_kategorie.idTABELLE_Parameter_Kategorie, tabelle_parameter.idTABELLE_Parameter 
     FROM tabelle_parameter_kategorie 
     INNER JOIN (
         tabelle_parameter 
             
         INNER JOIN tabelle_projekt_elementparameter ON tabelle_parameter.idTABELLE_Parameter = tabelle_projekt_elementparameter.tabelle_parameter_idTABELLE_Parameter
     ) 
     ON tabelle_parameter_kategorie.idTABELLE_Parameter_Kategorie = tabelle_parameter.TABELLE_Parameter_Kategorie_idTABELLE_Parameter_Kategorie
     WHERE tabelle_projekt_elementparameter.tabelle_projekte_idTABELLE_Projekte = ? AND tabelle_parameter.`Bauangaben relevant` = 1
     ORDER BY tabelle_parameter_kategorie.Kategorie, tabelle_projekt_elementparameter.tabelle_elemente_idTABELLE_Elemente, tabelle_parameter.Bezeichnung"
);
$stmt->bind_param("i", $_SESSION["projectID"]);
$stmt->execute();
$result = $stmt->get_result();
$elementParamInfos = [];
while ($row = $result->fetch_assoc()) $elementParamInfos[] = $row;


// ------------------- MAIN ROOM LOOP -------------------
foreach ($raumparameter as $roomID => $roomParams) {
    if (!empty($roomIDsArray) && !in_array($roomID, $roomIDsArray)) continue;
    check_RG($messages, $roomParams);
    check_summe_leistungen($messages, $roomParams);
    check_dependency_non_zero($messages, $roomParams, 'IT Anbindung', 'ET_RJ45-Ports');
    check_dependency_non_zero($messages, $roomParams, 'ET_RJ45-Ports', 'IT Anbindung');
    check_max_value($messages, $roomParams, 'ET_Anschlussleistung_ZSV_W', 8000);
    foreach (['AV', 'SV', 'ZSV', 'USV'] as $na) {
        check_dependency_non_zero($messages, $roomParams, $na, "ET_Anschlussleistung_{$na}_W");
        check_dependency_non_zero($messages, $roomParams, $na, "EL_{$na} Steckdosen Stk");
    }
    foreach (['1 Kreis O2' => '2 Kreis O2', '1 Kreis Va' => '2 Kreis Va', '1 Kreis DL-5' => '2 Kreis DL-5'] as $p1 => $p2)
        check_dependency_non_zero($messages, $roomParams, $p1, $p2);

    // --- ELEMENTS IN ROOM ---
    $stmt = $mysqli->prepare(
        "SELECT tabelle_elemente.ElementID, tabelle_elemente.idTABELLE_Elemente, tabelle_elemente.Bezeichnung, tabelle_varianten.Variante, 
                Sum(tabelle_räume_has_tabelle_elemente.Anzahl) AS SummevonAnzahl
                     FROM tabelle_varianten 
                     INNER JOIN (tabelle_räume_has_tabelle_elemente 
                     INNER JOIN tabelle_elemente ON tabelle_räume_has_tabelle_elemente.TABELLE_Elemente_idTABELLE_Elemente = tabelle_elemente.idTABELLE_Elemente) 
                     ON tabelle_varianten.idtabelle_Varianten = tabelle_räume_has_tabelle_elemente.tabelle_Varianten_idtabelle_Varianten
                     WHERE tabelle_räume_has_tabelle_elemente.Verwendung = 1
                     GROUP BY tabelle_elemente.ElementID, tabelle_elemente.Bezeichnung, tabelle_varianten.Variante, tabelle_räume_has_tabelle_elemente.`Neu/Bestand`, 
                              tabelle_räume_has_tabelle_elemente.TABELLE_Elemente_idTABELLE_Elemente, tabelle_räume_has_tabelle_elemente.tabelle_Varianten_idtabelle_Varianten, 
                              tabelle_räume_has_tabelle_elemente.TABELLE_Räume_idTABELLE_Räume
                     HAVING tabelle_räume_has_tabelle_elemente.TABELLE_Räume_idTABELLE_Räume = ? 
                        AND SummevonAnzahl > 0
                     ORDER BY tabelle_elemente.ElementID, tabelle_varianten.Variante");

    $stmt->bind_param("i", $roomID);
    $stmt->execute();
    $result = $stmt->get_result();

    $elements_in_room = [];
    $NetzArtenImRaum = [];
    $LeistungImRaum = $LeistungImRaumExkl = array_fill(0, 5, 0);
    $Abwarme = $AbwarmeExkl = 0;
    $check4Vorabsperrkasten = false;

    while ($row = $result->fetch_assoc()) {
        $elements_in_room[] = $row;

        foreach ($allElementMappings as $id => $info) {
            if (intval($row['idTABELLE_Elemente']) == $id) {
                $params = is_array($info['param']) ? $info['param'] : [$info['param']];
                foreach ($params as $param) {
                    check_4_room_param($messages, $roomParams, $param, $row);
                }
            }
        }

        foreach ($IDsWandverstärkung as $id) {
            if (intval($row['idTABELLE_Elemente']) == $id) {
                $hasWandverstaerkung = false;

                foreach ($elementParamInfos as $parameterInfo) {
                    if (
                        $parameterInfo["tabelle_Varianten_idtabelle_Varianten"] === abcTo123($row['Variante'])
                        && $row['idTABELLE_Elemente'] === $parameterInfo["tabelle_elemente_idTABELLE_Elemente"]
                        && $parameterInfo["idTABELLE_Parameter"] == 97 // ID des Parameters Wandverstärkung
                    ) {
                        $hasWandverstaerkung = true;
                        break;
                    }
                }

                if (!$hasWandverstaerkung) {
                    $messages[] = sprintf(
                        ERROR_MESSAGES['element_param4z'],
                        $roomParams['Raumbezeichnung'],
                        $roomParams['Raumnr'],
                        $roomParams['idTABELLE_Räume'],
                        $row['Bezeichnung'],
                        "Wandverstärkung",
                        "nicht vorhanden"
                    );
                }
            }
        }


        $temp_LeistungElement = 0;
        $tempNA_perElement = [];
        $temp_GLZ = 1.0;
        $Abwarme_el = 0;
        $AnzahlElImRaum = $row['SummevonAnzahl'];

        foreach ($elementParamInfos as $parameterInfo) {
            if ($parameterInfo["tabelle_Varianten_idtabelle_Varianten"] === abcTo123($row['Variante'])
                && $row['idTABELLE_Elemente'] === $parameterInfo["tabelle_elemente_idTABELLE_Elemente"]) {
                switch ($parameterInfo['idTABELLE_Parameter_Kategorie']) {
                    case 2: // ElektroTechnik
                        if ($parameterInfo['idTABELLE_Parameter'] === 127)
                            check_room_for_parameters_cause_elementParamKathegorie($messages, $roomParams, $parameterInfo['idTABELLE_Parameter'], $row);
                        if ($parameterInfo['idTABELLE_Parameter'] === 82) {
                            $tempNA_perElement = array_merge(getComponents($parameterInfo['Wert']), getComponents($parameterInfo['Einheit']));
                            $NetzArtenImRaum = getUniqueComponents($tempNA_perElement, $NetzArtenImRaum);
                        }
                        if ($parameterInfo['idTABELLE_Parameter'] === 18)
                            $temp_LeistungElement = floatval(str_replace(",", ".", preg_replace("/[^0-9.,]/", "", $parameterInfo['Wert']))) * unitMultiplier($parameterInfo["Einheit"]);
                        if ($parameterInfo['idTABELLE_Parameter'] === 133)
                            $temp_GLZ = floatval(str_replace(",", ".", preg_replace("/[^0-9,.]/", "", $parameterInfo['Wert'])));
                        break;
                    case 3: // HKLS
                        if ($parameterInfo["idTABELLE_Parameter"] === 9)
                            $Abwarme_el = floatval(str_replace(",", ".", preg_replace("/[^0-9.,]/", "", $parameterInfo['Wert']))) * unitMultiplier($parameterInfo["Einheit"]);
                        break;
                    case 12: // MEDGAS
                        check_room_for_parameters_cause_elementParamKathegorie($messages, $roomParams, $parameterInfo['idTABELLE_Parameter'], $row);
                        if (stripos($row['Bezeichnung'], "stativ") && !$check4Vorabsperrkasten)
                            $check4Vorabsperrkasten = true;
                        break;
                }
            }
        }
        $Abwarme += $Abwarme_el * $temp_GLZ * $AnzahlElImRaum;
        $AbwarmeExkl += $Abwarme_el * $AnzahlElImRaum;
        $LeistungImRaum = distribute($temp_LeistungElement * $temp_GLZ * $AnzahlElImRaum, $LeistungImRaum, $tempNA_perElement);
        $LeistungImRaumExkl = distribute($temp_LeistungElement * $AnzahlElImRaum, $LeistungImRaumExkl, $tempNA_perElement);

        if ($temp_LeistungElement > 0 && empty($tempNA_perElement)) {
            $messages[] = sprintf(ERROR_MESSAGES['leistung_na_missing'],
                $roomParams['Raumbezeichnung'], $roomParams['Raumnr'], $roomParams['idTABELLE_Räume'], $row['Bezeichnung']);
        }
    }
    if ($check4Vorabsperrkasten) check4vorabsperr($messages, $roomParams, $elements_in_room);
    check_max_value_rev($messages, $roomParams, "HT_Waermeabgabe_W", $Abwarme, " (INKL. GLZ)");
    check_max_value_rev($messages, $roomParams, "HT_Waermeabgabe_W", $AbwarmeExkl, " (EXKL. GLZ)");
    check_room_for_na($messages, $roomParams, $NetzArtenImRaum);
    check_room_Leistungssumme($messages, $roomParams, $LeistungImRaum, " (INKL. GLZ)");
    check_room_Leistungssumme($messages, $roomParams, $LeistungImRaumExkl, " (EXKL. GLZ)");
}
$mysqli->close();
if (empty($messages)) {
    echo sprintf(ERROR_MESSAGES['no_errors'], 'Alle', 'ausgewählten', 'n/a');
} else {
    foreach ($messages as $msg) echo br2nl($msg);
}
?>
